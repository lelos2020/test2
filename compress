Public Sub StratifyData(ws As Worksheet, colDict As Object, fieldCode As String, OutputSheetName As String, TableTitle As String, StratificationMode As String, Optional FieldInfo As CFieldValidationInfo)

    Dim IsCalculatedField As Boolean
    Dim IsListField As Boolean
    Dim uniqueItems As Scripting.Dictionary
    Dim fieldValue As Variant
    Dim buckets() As Double
    Dim range As Double, stepInterval As Double
    Dim BucketDict As Object
    Dim totalBalance As Double, totalPreCompressionMargin As Double, totalPostCompressionMargin As Double
    Dim remainingReduction As Double, marginCompressionBps As Double
    Dim bucketKey As Variant, loanData As Variant
    Dim bucketBalance As Double, bucketMargin As Double
    Dim HYLoanPrepayPct As Double, CPR As Double
    Dim sortedKeys() As Variant, i As Long
    
    IsCalculatedField = (fieldCode = "Remaining Term" Or fieldCode = "Seasoning" Or fieldCode = "Year of Origination" Or fieldCode = "Time to Reversion")

    If FieldInfo.DataType = "List" Then
        Set uniqueItems = CreateObject("Scripting.Dictionary")
        IsListField = True
    End If

    ' Check if the field code is in the dictionary
    If Not IsCalculatedField And Not colDict.Exists(fieldCode) Then
        MsgBox "Field code " & fieldCode & " not found in the dataset."
        Exit Sub
    End If

    ' Get the column numbers
    Dim colnumber As Integer, colCurrentBalance As Integer, colMargin As Integer
    colnumber = colDict.item(fieldCode)
    colCurrentBalance = colDict.item("AR67")
    colMargin = colDict.item("AR109")

    ' Initialize variables and dictionary
    Set BucketDict = CreateObject("Scripting.Dictionary")
    totalBalance = 0
    totalPreCompressionMargin = 0
    totalPostCompressionMargin = 0
    HYLoanPrepayPct = ThisWorkbook.Sheets("Control").Cells(13, 12).Value ' High-yield prepay %
    CPR = ThisWorkbook.Sheets("Control").Cells(12, 12).Value ' CPR %

    ' Populate the BucketDict
    Dim currentBalance As Double, currentMargin As Double
    For r = startRow To lastRow
        If filter = True And ws.Rows(r).EntireRow.Hidden Then GoTo ContinueLoop

        currentBalance = ws.Cells(r, colCurrentBalance).Value
        currentMargin = ws.Cells(r, colMargin).Value
        fieldValue = ws.Cells(r, colnumber).Value
        
        Dim BucketKey As String
        BucketKey = GetBucketKey(fieldValue, buckets, StratificationMode, FieldInfo)

        If Not BucketDict.Exists(BucketKey) Then
            BucketDict.Add BucketKey, New Collection
        End If
        BucketDict(BucketKey).Add Array(currentBalance, currentMargin)

        ' Accumulate total balance and pre-compression margin
        totalBalance = totalBalance + currentBalance
        totalPreCompressionMargin = totalPreCompressionMargin + (currentMargin * currentBalance)

ContinueLoop:
    Next r

    ' Normalize pre-compression margin
    If totalBalance > 0 Then
        totalPreCompressionMargin = totalPreCompressionMargin / totalBalance
    End If

    ' Sort dictionary keys (assuming numerical order for buckets)
    sortedKeys = BucketDict.Keys
    Call SortDictionaryKeys(sortedKeys)

    ' Apply staggered margin compression (from highest bucket)
    remainingReduction = totalBalance * CPR * HYLoanPrepayPct
    For i = UBound(sortedKeys) To LBound(sortedKeys) Step -1
        bucketKey = sortedKeys(i)
        bucketBalance = 0
        bucketMargin = 0

        ' Aggregate bucket balance and margin
        For Each loanData In BucketDict(bucketKey)
            bucketBalance = bucketBalance + loanData(1)
            bucketMargin = bucketMargin + (loanData(2) * loanData(1))
        Next loanData

        ' Apply reduction
        If remainingReduction > 0 Then
            If bucketBalance <= remainingReduction Then
                ' Fully reduce the bucket
                remainingReduction = remainingReduction - bucketBalance
                bucketBalance = 0
            Else
                ' Partially reduce the bucket
                bucketBalance = bucketBalance - remainingReduction
                remainingReduction = 0
            End If
        End If

        ' Update post-compression margin
        For Each loanData In BucketDict(bucketKey)
            totalPostCompressionMargin = totalPostCompressionMargin + (loanData(2) * bucketBalance)
        Next loanData
    Next i

    ' Normalize post-compression margin
    If totalBalance > 0 Then
        totalPostCompressionMargin = totalPostCompressionMargin / totalBalance
    End If

    ' Calculate margin compression in bps
    marginCompressionBps = (totalPreCompressionMargin - totalPostCompressionMargin) * 10000

    ' Output margin compression to Control tab
    ThisWorkbook.Sheets("Control").Cells(15, 12).Value = "Margin Compression (bps)"
    ThisWorkbook.Sheets("Control").Cells(16, 12).Value = marginCompressionBps
    ThisWorkbook.Sheets("Control").Cells(16, 12).NumberFormat = "0.00"

    ' Optional: Call OutputBuckets or any other processing function
    Call OutputMod.OutputBuckets(ws, BucketDict, OutputSheetName, TableTitle)
End Sub

' Helper function to determine the bucket key
Private Function GetBucketKey(fieldValue As Variant, buckets() As Double, StratificationMode As String, FieldInfo As CFieldValidationInfo) As String
    Dim BucketKey As String, i As Long

    If StratificationMode = "Numerical" Then
        For i = LBound(buckets) To UBound(buckets) - 1
            If fieldValue >= buckets(i) And fieldValue < buckets(i + 1) Then
                BucketKey = buckets(i) & "-" & buckets(i + 1)
                Exit For
            End If
        Next i
        If fieldValue < buckets(LBound(buckets)) Then
            BucketKey = "<" & buckets(LBound(buckets))
        ElseIf fieldValue >= buckets(UBound(buckets)) Then
            BucketKey = ">" & buckets(UBound(buckets))
        End If
    ElseIf StratificationMode = "Categorical" Then
        BucketKey = CStr(fieldValue)
    End If
    GetBucketKey = BucketKey
End Function

' Helper function to sort dictionary keys
Private Sub SortDictionaryKeys(ByRef keys() As Variant)
    Dim i As Long, j As Long, temp As Variant
    For i = LBound(keys) To UBound(keys) - 1
        For j = i + 1 To UBound(keys)
            If keys(i) > keys(j) Then
                temp = keys(i)
                keys(i) = keys(j)
                keys(j) = temp
            End If
        Next j
    Next i
End Sub